#!/usr/bin/env ruby
# coding: utf-8

require 'rubygems'
require 'bundler'

Bundler.setup
Bundler.require

unless ARGV.length == 2
  puts 'Run as ./tram-countdow [line] [destination]'
  exit(1)
end
line        = ARGV[0]
destination = ARGV[1]

while true do
  result  = MVG::Live.fetch('TrappentreustraÃŸe')
  minutes = result.select { |info| info[:line] == line && info[:destination] == destination && info[:minutes] > 0 }.map { |info| info[:minutes] }.min || 0

  lights = []
  (13 - minutes).times { lights << 0x00 }
  minutes.times { lights << 0x05 }
  IO.popen('./../../usbhost/sldtool_mac', 'w') { |sld| sld.write lights.pack('C*') }

  sleep(10)
end
